<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D ä¸“æ³¨ç”Ÿæ€ - æ£®æ—ä¸ä¼™ä¼´ Pro Max</title>
    <style>
        :root {
            /* æ–°æ‹Ÿæ€æ ¸å¿ƒè‰²æ¿ */
            --bg-color: #e0e5ec;
            --text-main: #4d5b6d;
            --text-sub: #a3b1c6;
            --text-gray: #64748b; 
            
            /* å…‰å½± */
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            
            /* å“ç‰Œè‰² - è°ƒæ•´ä¸ºæ›´çº¯æ­£çš„ç»¿è‰² */
            --primary-green: #22c55e; 
            --primary-blue: #3b82f6; 
            --dark-green: #14532d;
            --warn-yellow: #f59e0b;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            user-select: none;
            color: var(--text-main);
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        .ui-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 30px;
            box-sizing: border-box;
            z-index: 10;
        }

        /* æ–°æ‹Ÿæ€æ··åˆæ ·å¼ */
        .neu-out {
            background: var(--bg-color);
            border-radius: 16px;
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* é¡¶éƒ¨æ•°æ®æ  */
        .stats-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stats-panel {
            pointer-events: auto;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease;
            color: var(--text-main);
        }
        
        .stats-panel:hover { transform: translateY(-2px); }
        .stats-panel:active { transform: scale(0.98); }

        .highlight-num {
            font-size: 18px;
            font-weight: 800;
            color: var(--text-main); 
            text-shadow: none; 
        }

        /* å³ä¾§ï¼šç§å­åº“ */
        .seed-selector {
            pointer-events: auto;
            position: absolute;
            top: 100px; bottom: 40px; right: 30px; width: 180px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto; 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: translateX(0); opacity: 1;
        }
        
        .seed-selector.hidden { transform: translateX(150%); opacity: 0; pointer-events: none; }
        .seed-selector::-webkit-scrollbar { width: 0px; }

        .selector-title {
            font-size: 12px; color: var(--text-sub); font-weight: 700; margin-bottom: 5px; 
            text-transform: uppercase; letter-spacing: 1px; text-align: center;
        }

        .seed-option {
            display: flex; align-items: center;
            gap: 12px; padding: 12px 16px;
            border-radius: 50px; cursor: pointer; transition: all 0.2s ease;
            background: var(--bg-color);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            color: var(--text-main);
        }
        .seed-option:hover { transform: translateY(-2px); }
        .seed-option.active {
            box-shadow: inset 4px 4px 8px var(--shadow-dark), inset -4px -4px 8px var(--shadow-light);
            color: var(--text-main); 
            font-weight: bold; 
            transform: none;
        }
        .seed-icon { font-size: 20px; width: 24px; text-align: center; }
        .seed-name { font-size: 13px; font-weight: 600; }

        /* åº•éƒ¨ä¸­å¤®ï¼šæ§åˆ¶å° */
        .controls {
            pointer-events: auto;
            align-self: center; text-align: center; position: relative; bottom: 30px;
            display: flex; flex-direction: column; align-items: center; gap: 35px;
        }

        /* --- æ ¸å¿ƒç»„ä»¶ï¼šæ‚¬æµ®èƒ½é‡ç¯ (Focus Ring) --- */
        .focus-ring-container {
            position: relative;
            width: 280px;
            height: 280px;
            border-radius: 50%;
            background: var(--bg-color);
            /* æŸ”å’Œçš„å¤–å‡¸ */
            box-shadow: 20px 20px 60px var(--shadow-dark), -20px -20px 60px var(--shadow-light);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s;
            z-index: 20;
        }

        .focus-ring-container:hover {
            transform: scale(1.02) translateY(-5px);
            box-shadow: 25px 25px 70px var(--shadow-dark), -25px -25px 70px var(--shadow-light);
        }
        .focus-ring-container:active {
            transform: scale(0.98);
        }

        /* 2. ä¸­å±‚ï¼šè½¨é“ (Groove) - æçª„å‡¹æ§½ */
        .ring-groove {
            position: absolute;
            top: 20px; left: 20px; right: 20px; bottom: 20px;
            border-radius: 50%;
            background: var(--bg-color);
            /* æµ…è€Œç²¾è‡´çš„å†…é˜´å½± */
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            z-index: 1;
        }

        /* SVG è¿›åº¦æ¡å±‚ */
        .progress-ring {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transform: rotate(-90deg);
            pointer-events: none;
            z-index: 2;
        }

        /* èƒŒæ™¯è½¨é“ - æ¢å¤æ˜¾ç¤ºï¼Œæä¾›è§†è§‰æ”¯æ’‘ */
        .progress-ring__circle-bg {
            display: block;
            fill: none;
            stroke: rgba(163, 177, 198, 0.2); /* ææ·¡çš„ç°è‰²è½¨é“ */
            stroke-width: 6;
        }

        .progress-ring__circle {
            fill: none;
            stroke: var(--primary-green); /* çº¯æ­£çš„ç»¿è‰² */
            stroke-width: 6; /* æç»†çº¿æ¡ */
            stroke-linecap: round;
            stroke-dasharray: 716; 
            stroke-dashoffset: 0; 
            transition: stroke-dashoffset 1s linear;
            /* å¢åŠ ä¸€ç‚¹å¾®å‘å…‰ï¼Œæå‡è´¨æ„Ÿ */
            filter: drop-shadow(0 0 2px rgba(34, 197, 94, 0.4));
            opacity: 1;
        }

        /* 3. å†…å±‚ï¼šè¡¨ç›˜ (Center Plate) */
        .center-plate {
            position: absolute;
            top: 35px; left: 35px; right: 35px; bottom: 35px;
            border-radius: 50%;
            background: var(--bg-color);
            /* å‡¸èµ·æ•ˆæœ */
            box-shadow: 6px 6px 12px var(--shadow-dark), -6px -6px 12px var(--shadow-light);
            z-index: 3;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .timer-text {
            font-size: 68px; 
            font-weight: 700;
            color: var(--text-gray); 
            font-family: 'Segoe UI', Roboto, sans-serif;
            font-variant-numeric: tabular-nums;
            margin-bottom: 2px;
            letter-spacing: -1px;
            text-shadow: none;
        }
        
        .status-text {
            font-size: 16px; 
            font-weight: 600;
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s;
        }

        /* Tooltip - å”¯ä¸€ä¸”ç¨³å®šçš„æç¤ºæ¡† */
        .timer-tooltip {
            position: absolute;
            bottom: -50px; /* ç§»åˆ°æ›´ä¸‹æ–¹ï¼Œå®Œå…¨é¿å¼€é¼ æ ‡ */
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            font-size: 12px;
            color: var(--text-sub);
            background: rgba(255,255,255,0.6); /* ç¨å¾®é€æ˜ä¸€ç‚¹ */
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            opacity: 0;
            transition: opacity 0.4s ease, transform 0.4s ease;
            pointer-events: none;
            white-space: nowrap;
            z-index: 100;
            backdrop-filter: blur(5px);
        }
        .focus-ring-container:hover .timer-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* çŠ¶æ€é¢œè‰² */
        .focus-ring-container.focusing .timer-text { color: var(--text-gray); }
        .focus-ring-container.focusing .status-text { color: var(--primary-green); opacity: 1; }
        
        /* æš‚åœ */
        .focus-ring-container.paused .timer-text { color: var(--warn-yellow); animation: none; }
        .focus-ring-container.paused .status-text { color: var(--warn-yellow); }
        .focus-ring-container.paused .progress-ring__circle { stroke: var(--warn-yellow); }


        /* æ§åˆ¶æ å®¹å™¨ */
        .controls-row {
            display: flex; align-items: center; gap: 20px; padding: 10px 20px;
            border-radius: 40px; background: var(--bg-color);
            box-shadow: 8px 8px 16px var(--shadow-dark), -8px -8px 16px var(--shadow-light);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: translateY(0); opacity: 1;
        }
        
        .controls-row.hidden {
            opacity: 0; pointer-events: none; transform: translateY(50px) scale(0.9);
        }

        .preset-btn {
            border: none; background: var(--bg-color); color: var(--text-sub);
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600;
            cursor: pointer; transition: all 0.2s;
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }
        .preset-btn:hover { color: var(--text-main); transform: translateY(-1px); }
        .preset-btn.active { 
            color: var(--text-main); 
            box-shadow: inset 3px 3px 6px var(--shadow-dark), inset -3px -3px 6px var(--shadow-light);
            font-weight: bold;
        }

        /* éŸ³ä¹æŒ‰é’® */
        .audio-dropdown { position: relative; }
        .audio-btn {
            background: var(--bg-color); border: none; border-radius: 50%;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 18px; color: var(--text-sub);
            box-shadow: 4px 4px 8px var(--shadow-dark), -4px -4px 8px var(--shadow-light);
            transition: all 0.2s;
        }
        .audio-btn:hover { color: var(--primary-green); transform: translateY(-1px); }

        .audio-menu {
            display: none; position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%);
            width: 140px; padding: 15px; z-index: 100; flex-direction: column; gap: 10px;
            margin-bottom: 0;
        }
        /* å½“èœå•æœ‰showç±»æ—¶ï¼Œæ˜¾ç¤ºèœå• */
        .audio-menu.show {
            display: flex;
        }
        
        /* éŸ³ä¹é€‰é¡¹ */
        .audio-item {
            pointer-events: auto;
        }
        
        .audio-item {
            padding: 10px; font-size: 13px; color: var(--text-main); cursor: pointer;
            border-radius: 10px; display: flex; align-items: center; gap: 8px;
            background: var(--bg-color);
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
        }
        .audio-item:hover { color: var(--primary-green); }
        .audio-item.selected { 
            color: var(--primary-green); font-weight: bold;
            box-shadow: inset 2px 2px 5px var(--shadow-dark), inset -2px -2px 5px var(--shadow-light);
        }

        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-weight: bold; color: var(--text-main); transition: opacity 0.5s;
            text-shadow: 1px 1px 0 #fff;
        }
        
        .preview-label {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            color: var(--text-sub); font-size: 12px; font-weight: bold; opacity: 0.4;
            pointer-events: none; text-transform: uppercase; letter-spacing: 4px;
            text-shadow: 1px 1px 0 #fff;
        }

        /* Exit button */
        .exit-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-color);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-main);
            z-index: 1000;
            transition: all 0.2s ease;
            pointer-events: auto;
        }

        .exit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);
        }

        .exit-btn:active {
            transform: scale(0.95);
        }
        
        /* Help button */
        .help-btn {
            position: absolute;
            top: 30px;
            right: 80px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-color);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-main);
            z-index: 1000;
            transition: all 0.2s ease;
            pointer-events: auto;
        }
        
        .help-btn:hover {
            transform: translateY(-2px);
            box-shadow: 7px 7px 14px var(--shadow-dark), -7px -7px 14px var(--shadow-light);
            color: var(--primary-green);
        }
        
        .help-btn:active {
            transform: scale(0.95);
        }
        
        /* Guide card */
        .guide-card {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            padding: 30px;
            background: var(--bg-color);
            box-shadow: 20px 20px 60px var(--shadow-dark), -20px -20px 60px var(--shadow-light);
            border-radius: 20px;
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
            pointer-events: auto;
        }
        
        .guide-card.show {
            display: flex;
            animation: fadeInScale 0.3s ease-out forwards;
        }
        
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        .guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(163, 177, 198, 0.2);
        }
        
        .guide-header h3 {
            margin: 0;
            color: var(--text-main);
            font-size: 24px;
            font-weight: 700;
        }
        
        .guide-close {
            background: var(--bg-color);
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-sub);
            box-shadow: 3px 3px 6px var(--shadow-dark), -3px -3px 6px var(--shadow-light);
            transition: all 0.2s ease;
        }
        
        .guide-close:hover {
            color: var(--text-main);
            transform: translateY(-1px);
            box-shadow: 5px 5px 10px var(--shadow-dark), -5px -5px 10px var(--shadow-light);
        }
        
        .guide-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .guide-content::-webkit-scrollbar {
            width: 6px;
        }
        
        .guide-content::-webkit-scrollbar-track {
            background: rgba(163, 177, 198, 0.1);
            border-radius: 3px;
        }
        
        .guide-content::-webkit-scrollbar-thumb {
            background: rgba(163, 177, 198, 0.5);
            border-radius: 3px;
        }
        
        .guide-content::-webkit-scrollbar-thumb:hover {
            background: rgba(163, 177, 198, 0.7);
        }
        
        .guide-content h4 {
            margin: 20px 0 10px 0;
            color: var(--text-main);
            font-size: 16px;
            font-weight: 700;
        }
        
        .guide-content h4:first-child {
            margin-top: 0;
        }
        
        .guide-content ul {
            margin: 0 0 15px 0;
            padding-left: 25px;
            color: var(--text-gray);
            font-size: 14px;
            line-height: 1.6;
        }
        
        .guide-content li {
            margin-bottom: 8px;
        }
        
        .guide-content strong {
            color: var(--text-main);
            font-weight: 600;
        }
    </style>
    <!-- å¼•å…¥ Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    
    <div id="loader">NEUMORPHISM FOREST...</div>
    <div id="canvas-container"></div>
    
    <audio id="bgMusic" loop><source src="" type="audio/ogg"></audio>
    
    <!-- Exit button -->
        <div class="exit-btn" id="exitBtn">âœ•</div>
        
        <!-- Help button and guide -->
        <div class="help-btn" id="helpBtn">?</div>
        <div class="guide-card neu-out" id="guideCard">
            <div class="guide-header">
                <h3>ğŸŒ² 3Dä¸“æ³¨ç”Ÿæ€æŒ‡å—</h3>
                <button class="guide-close" id="guideClose">âœ•</button>
            </div>
            <div class="guide-content">
                <h4>ğŸ“‹ åŸºæœ¬è§„åˆ™</h4>
                <ul>
                    <li>è®¾å®šä¸“æ³¨æ—¶é—´ï¼Œç‚¹å‡»å¼€å§‹æŒ‰é’®è¿›å…¥ä¸“æ³¨çŠ¶æ€</li>
                    <li>å®Œæˆä¸“æ³¨åï¼Œè·å¾—ä¸€æ£µæ¤ç‰©æˆ–ä¸€åªåŠ¨ç‰©</li>
                    <li>æ¤ç‰©å’ŒåŠ¨ç‰©ä¼šç§æ¤åœ¨ä½ çš„3Dæ£®æ—ä¸­</li>
                    <li>ç´¯è®¡ç§æ¤æ›´å¤šç”Ÿå‘½ï¼Œæ‰“é€ ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿ</li>
                </ul>
                
                <h4>ğŸ¯ æ“ä½œæŒ‡å—</h4>
                <ul>
                    <li>ğŸ–±ï¸ <strong>å•å‡»èƒ½é‡ç¯</strong> - å¼€å§‹/ç»§ç»­ä¸“æ³¨</li>
                    <li>ğŸ–±ï¸ <strong>åŒå‡»èƒ½é‡ç¯</strong> - æš‚åœä¸“æ³¨</li>
                    <li>ğŸ–±ï¸ <strong>åŒå‡»è®¡æ—¶å™¨</strong> - ä¿®æ”¹ä¸“æ³¨æ—¶é•¿</li>
                    <li>ğŸ–±ï¸ <strong>åŒå‡»ç»Ÿè®¡æ•°æ®</strong> - ä¿®æ”¹æ€»æ•°å’Œä»Šæ—¥æˆå°±</li>
                    <li>ğŸ–±ï¸ <strong>æ‹–åŠ¨é¼ æ ‡</strong> - æ—‹è½¬è§†è§’</li>
                    <li>ğŸ–±ï¸ <strong>æ»šè½®ç¼©æ”¾</strong> - æ”¾å¤§ç¼©å°åœºæ™¯</li>
                </ul>
                
                <h4>ğŸµ éŸ³ä¹è®¾ç½®</h4>
                <ul>
                    <li>ç‚¹å‡»éŸ³ä¹å›¾æ ‡æ‰“å¼€éŸ³ä¹èœå•</li>
                    <li>é€‰æ‹©å–œæ¬¢çš„èƒŒæ™¯éŸ³ä¹æˆ–é™éŸ³</li>
                    <li>æ”¯æŒå¤šç§éŸ³æ•ˆï¼šæ£®æ—ã€é˜¿å°”æ³•æ³¢ã€å¸Œå¡”æ³¢ç­‰</li>
                </ul>
                
                <h4>ğŸŒ¿ ç‰©ç§é€‰æ‹©</h4>
                <ul>
                    <li>å³ä¾§é¢æ¿é€‰æ‹©ä½ å–œæ¬¢çš„æ¤ç‰©æˆ–åŠ¨ç‰©</li>
                    <li>å®Œæˆä¸“æ³¨åå°†è·å¾—æ‰€é€‰ç‰©ç§</li>
                    <li>æ¤ç‰©å’ŒåŠ¨ç‰©ä¼šè‡ªåŠ¨åˆ†å¸ƒåœ¨æ£®æ—ä¸­</li>
                </ul>
            </div>
        </div>

    <div class="ui-container">
        <!-- é¡¶éƒ¨æ•°æ® (æ–°æ‹Ÿæ€é¢æ¿) -->
        <div class="stats-bar">
            <!-- ç§»é™¤ title å±æ€§ï¼Œé˜²æ­¢æµè§ˆå™¨åŸç”Ÿæç¤ºæ¡†å¹²æ‰° -->
            <div class="neu-out stats-panel" id="statsTotal">
                <span>ğŸŒ² æ€»æ•°</span>
                <span class="highlight-num" id="totalCount">0</span>
            </div>
            <div class="neu-out stats-panel" id="statsToday">
                <span>â˜€ï¸ ä»Šæ—¥</span>
                <span class="highlight-num" id="todayCount">0</span>
            </div>
        </div>
        
        <!-- é¢„è§ˆæç¤º -->
        <div class="preview-label" id="previewLabel">PREVIEW</div>

        <!-- åº•éƒ¨æ§åˆ¶ï¼šä¸€ä½“åŒ–è®¾è®¡ -->
        <div class="controls">
            
            <!-- é¢„è®¾æ—¶é—´ + éŸ³ä¹ (ä¸“æ³¨æ—¶éšè—) -->
            <div class="controls-row" id="controlsRow">
                <div id="presetGroup" style="display: flex; gap: 12px;">
                    <button class="preset-btn active" data-time="25">25 min</button>
                    <button class="preset-btn" data-time="45">45 min</button>
                    <button class="preset-btn" data-time="60">60 min</button>
                </div>
                
                <div class="audio-dropdown">
                    <button class="audio-btn" id="audioToggle">ğŸµ</button>
                    <div class="neu-out audio-menu">
                        <div class="audio-item selected" onclick="setSound('mute')">ğŸ”‡ é™éŸ³</div>
                        <div class="audio-item" onclick="setSound('forest')">ğŸŒ² è¿·é›¾æ£®æ—</div>
                        <div class="audio-item" onclick="setSound('alpha')">ğŸ§  é˜¿å°”æ³•æ³¢</div>
                        <div class="audio-item" onclick="setSound('theta')">ğŸ§˜ å¸Œå¡”æ³¢</div>
                        <div class="audio-item" onclick="setSound('beta')">ğŸ’ª è´å¡”æ³¢</div>
                        <div class="audio-item" onclick="setSound('ocean')">ğŸŒŠ æµ·æµªå£°</div>
                    </div>
                </div>
            </div>
            
            <!-- æ ¸å¿ƒï¼šæ‚¬æµ®èƒ½é‡ç¯ (è®¡æ—¶å™¨+æŒ‰é’®ä¸€ä½“åŒ–) -->
            <!-- ç§»é™¤ title å±æ€§ -->
            <div class="focus-ring-container" id="focusRing">
                <!-- å”¯ä¸€çš„ Tooltip -->
                <div class="timer-tooltip">åŒå‡»æ•°å­—ä¿®æ”¹ / å•å‡»å¼€å§‹ / åŒå‡»åœ†ç¯æš‚åœ</div>
                
                <!-- 1. å¤–éƒ¨å‡¹æ§½ (Track) -->
                <div class="ring-groove">
                    <!-- SVG è¿›åº¦æ¡ -->
                    <svg class="progress-ring" viewBox="0 0 240 240">
                        <!-- èƒŒæ™¯è½¨é“: æµ…ç° -->
                        <circle class="progress-ring__circle-bg" r="114" cx="120" cy="120"/>
                        <!-- è¿›åº¦æ¡ -->
                        <circle class="progress-ring__circle" id="progressCircle" r="114" cx="120" cy="120"/>
                    </svg>
                </div>

                <!-- 2. å†…éƒ¨å‡¸èµ·åœ†ç›˜ (Center Plate) -->
                <div class="center-plate">
                    <!-- ç§»é™¤ title å±æ€§ -->
                    <div class="timer-text" id="timer">25:00</div>
                    <div class="status-text" id="statusText">ç‚¹å‡»å¼€å§‹</div>
                </div>
            </div>

        </div>

        <!-- ä¾§è¾¹ç§å­é€‰æ‹© -->
        <div class="neu-out seed-selector" id="seedSelector">
            <div class="selector-title">ğŸŒ¿ æ¤ç‰©ç±»</div>
            <!-- åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as TWEEN from 'https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/libs/tween.module.min.js';

        // --- é…ç½®åŒº ---
        const GROUND_SIZE = 180;
        const NEU_BG_COLOR = 0xe0e5ec;
        // r=114 -> C = 2 * PI * 114 â‰ˆ 716
        const FULL_DASH_ARRAY = 716; 
        
        const SPECIES = {
            plants: [
                { id: 'pine', name: 'æ¾æ ‘', icon: 'ğŸŒ²' },
                { id: 'oak', name: 'æ©¡æ ‘', icon: 'ğŸŒ³' },
                { id: 'cherry', name: 'æ¨±èŠ±', icon: 'ğŸŒ¸' },
                { id: 'willow', name: 'å‚æŸ³', icon: 'ğŸŒ¿' },
                { id: 'bamboo', name: 'ç«¹å­', icon: 'ğŸ‹' },
                { id: 'palm', name: 'æ¤°æ ‘', icon: 'ğŸŒ´' },
                { id: 'cactus', name: 'ä»™äººæŒ', icon: 'ğŸŒµ' },
                { id: 'mushroom', name: 'å·¨è‡', icon: 'ğŸ„' },
                { id: 'sunflower', name: 'å‘æ—¥è‘µ', icon: 'ğŸŒ»' },
                { id: 'birch', name: 'ç™½æ¡¦', icon: 'ğŸªµ' }
            ],
            animals: [
                { id: 'rabbit', name: 'ç™½å…”', icon: 'ğŸ°' },
                { id: 'fox', name: 'èµ¤ç‹', icon: 'ğŸ¦Š' },
                { id: 'panda', name: 'ç†ŠçŒ«', icon: 'ğŸ¼' },
                { id: 'pig', name: 'å°çŒª', icon: 'ğŸ·' },
                { id: 'chick', name: 'å°é¸¡', icon: 'ğŸ¤' },
                { id: 'penguin', name: 'ä¼é¹…', icon: 'ğŸ§' },
                { id: 'frog', name: 'é’è›™', icon: 'ğŸ¸' },
                { id: 'sheep', name: 'ç»µç¾Š', icon: 'ğŸ‘' },
                { id: 'bear', name: 'æ£•ç†Š', icon: 'ğŸ»' },
                { id: 'bee', name: 'èœœèœ‚', icon: 'ğŸ' }
            ]
        };

        const SOUNDS = {
            mute: '',
            forest: 'https://assets.mixkit.co/active_storage/sfx/2443/2443-preview.mp3', // è¿·é›¾æ£®æ—
            alpha: 'https://assets.mixkit.co/active_storage/sfx/243/243-preview.mp3', // é˜¿å°”æ³•æ³¢
            theta: 'https://assets.mixkit.co/active_storage/sfx/244/244-preview.mp3', // å¸Œå¡”æ³¢
            beta: 'https://assets.mixkit.co/active_storage/sfx/1126/1126-preview.mp3', // è´å¡”æ³¢
            ocean: 'https://assets.mixkit.co/active_storage/sfx/2441/2441-preview.mp3', // æµ·æµªå£°
            none: ''
        };

        // --- å…¨å±€å˜é‡ ---
        let scene, camera, renderer, controls;
        let ground, tomatoMesh, previewMesh;
        let entities = []; 
        let currentSeed = 'pine';
        let isFocusing = false;
        let isPaused = false;
        let timerInterval;
        let currentDuration = 25 * 60;
        let secondsLeft = 25 * 60;
        let currentSound = 'forest';
        let isMuted = false;
        let isAudioMenuOpen = false;

        const dom = {
            total: document.getElementById('totalCount'),
            today: document.getElementById('todayCount'),
            timer: document.getElementById('timer'),
            focusRing: document.getElementById('focusRing'),
            progressCircle: document.getElementById('progressCircle'),
            statusText: document.getElementById('statusText'),
            presetGroup: document.getElementById('presetGroup'),
            seedSelector: document.getElementById('seedSelector'),
            audioPlayer: document.getElementById('bgMusic'),
            audioToggle: document.getElementById('audioToggle'),
            previewLabel: document.getElementById('previewLabel'),
            controlsRow: document.getElementById('controlsRow'),
            statsTotal: document.getElementById('statsTotal'),
            statsToday: document.getElementById('statsToday'),
            exitBtn: document.getElementById('exitBtn'),
            helpBtn: document.getElementById('helpBtn'),
            guideCard: document.getElementById('guideCard'),
            guideClose: document.getElementById('guideClose')
        };

        // Get initial stats from URL parameters
        let totalPlants = 6; // é»˜è®¤æ€»æ•°ä¸º6
        let todayPlants = 0;
        let initialTimeLeft = 25 * 60; // é»˜è®¤25åˆ†é’Ÿ
        let initialIsActive = false;
        let initialDuration = 25 * 60; // é»˜è®¤25åˆ†é’Ÿ
        let initialIsMuted = false;
        let initialSoundId = 'forest'; // é»˜è®¤æ£®æ—éŸ³æ•ˆ

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('total')) {
            totalPlants = parseInt(urlParams.get('total') || '0');
        }
        if (urlParams.has('today')) {
            todayPlants = parseInt(urlParams.get('today') || '0');
        }
        if (urlParams.has('timeLeft')) {
            initialTimeLeft = parseInt(urlParams.get('timeLeft') || '1500');
        }
        if (urlParams.has('isActive')) {
            initialIsActive = urlParams.get('isActive') === 'true';
        }
        if (urlParams.has('duration')) {
            initialDuration = parseInt(urlParams.get('duration') || '1500');
        }
        if (urlParams.has('isMuted')) {
            initialIsMuted = urlParams.get('isMuted') === 'true';
        }
        if (urlParams.has('currentSoundId')) {
            initialSoundId = urlParams.get('currentSoundId') || 'forest';
        }
        
        // åˆå§‹åŒ–å…¨å±€å˜é‡ - åœ¨è¯»å–URLå‚æ•°åå†åˆå§‹åŒ–ï¼Œç¡®ä¿ä½¿ç”¨å®é™…çš„å‚æ•°å€¼
        isFocusing = initialIsActive;
        currentDuration = initialDuration;
        secondsLeft = initialTimeLeft;
        currentSound = initialSoundId;
        isMuted = initialIsMuted;

        let stats = { total: totalPlants, today: todayPlants };

        init();
        animate();

        function init() {
            // 1. åœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(NEU_BG_COLOR);
            scene.fog = new THREE.Fog(NEU_BG_COLOR, 60, 160);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 50, 80);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.1;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const sunLight = new THREE.DirectionalLight(0xffffff, 1.0);
            sunLight.position.set(40, 80, 40);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.left = -100;
            sunLight.shadow.camera.right = 100;
            sunLight.shadow.camera.top = 100;
            sunLight.shadow.camera.bottom = -100;
            sunLight.shadow.bias = -0.0005;
            scene.add(sunLight);

            const fillLight = new THREE.DirectionalLight(0xa3b1c6, 0.5);
            fillLight.position.set(20, 10, -20);
            scene.add(fillLight);

            createGround();
            createTomato();
            initRandomEcosystem(stats.total);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.maxPolarAngle = Math.PI / 2 - 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.8;

            buildSeedSelector();
            updatePreview(currentSeed);
            
            window.addEventListener('resize', onWindowResize);
            
            // --- æ¶ˆæ¯é€šä¿¡æœºåˆ¶ ---
            // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
            window.addEventListener('message', (event) => {
                if (event.data.type === 'syncState') {
                    // åŒæ­¥å¤–éƒ¨çŠ¶æ€åˆ°å†…éƒ¨
                    const { timeLeft, isActive, duration, isMuted: externalIsMuted, currentSoundId } = event.data;
                    
                    // å½“å†…éƒ¨è®¡æ—¶å™¨æ­£åœ¨è¿è¡Œæ—¶ï¼ŒåªåŒæ­¥durationã€isMutedå’ŒcurrentSoundIdï¼Œå¿½ç•¥timeLeftå’ŒisActive
                    // è¿™æ ·å¯ä»¥é¿å…çŠ¶æ€åŒæ­¥å¾ªç¯å¯¼è‡´çš„è¿›åº¦æ¡ç–¯ç‹‚æ—‹è½¬
                    const isInternalTimerRunning = isFocusing && !isPaused;
                    
                    // åŒæ­¥é¢„è®¾æ—¶é—´å’ŒæŒ‰é’®çŠ¶æ€
                    if (currentDuration !== duration) {
                        currentDuration = duration;
                        
                        // åŒæ­¥é¢„è®¾æŒ‰é’®çŠ¶æ€
                        const mins = Math.floor(duration / 60);
                        const btns = dom.presetGroup.querySelectorAll('.preset-btn');
                        btns.forEach(b => b.classList.remove('active'));
                        Array.from(btns).forEach(b => {
                            if(parseInt(b.dataset.time) === mins) b.classList.add('active');
                        });
                    }
                    
                    // åªæœ‰å½“å†…éƒ¨è®¡æ—¶å™¨æœªè¿è¡Œæ—¶ï¼Œæ‰åŒæ­¥timeLeftå’ŒisActive
                    if (!isInternalTimerRunning) {
                        secondsLeft = timeLeft;
                        updateTimerUI(secondsLeft);
                        setCircleProgress(secondsLeft / currentDuration);
                        
                        // åŒæ­¥æ’­æ”¾çŠ¶æ€
                        if (isActive && !isFocusing) {
                            startFocus(secondsLeft);
                        } else if (!isActive && isFocusing) {
                            resetFocus();
                        }
                    } else {
                        // å½“å†…éƒ¨è®¡æ—¶å™¨æ­£åœ¨è¿è¡Œæ—¶ï¼Œåªæ›´æ–°è¿›åº¦æ¡çš„æœ€å¤§å€¼ï¼ˆå¦‚æœdurationå˜åŒ–äº†ï¼‰
                        if (currentDuration !== duration) {
                            setCircleProgress(secondsLeft / duration);
                        }
                    }
                    
                    // åŒæ­¥èƒŒæ™¯éŸ³ä¹çŠ¶æ€
                    if (externalIsMuted !== isMuted) {
                        isMuted = externalIsMuted;
                        if (isMuted) {
                            dom.audioToggle.innerText = 'ğŸ”‡';
                            dom.audioPlayer.pause();
                        } else {
                            dom.audioToggle.innerText = 'ğŸµ';
                            playAudio(currentSound);
                        }
                    }
                    
                    if (currentSoundId !== currentSound) {
                        currentSound = currentSoundId;
                        window.setSound(currentSound);
                    }
                }
            });
            
            // --- æ ¸å¿ƒäº¤äº’é€»è¾‘ ---
            
            dom.focusRing.addEventListener('click', () => {
                if (!isFocusing) {
                    startFocus();
                } else if (isPaused) {
                    togglePause(); 
                }
            });

            dom.focusRing.addEventListener('dblclick', (e) => {
                if (isFocusing) {
                    togglePause();
                }
            });

            dom.timer.addEventListener('dblclick', (e) => {
                e.stopPropagation(); 
                if(isFocusing || isPaused) resetFocus(); 

                const input = prompt("è¯·è¾“å…¥ä¸“æ³¨æ—¶é•¿ï¼ˆç§’ï¼‰ï¼š", currentDuration);
                if (input && !isNaN(input) && Number(input) > 0) {
                    setDurationSeconds(parseInt(input));
                    dom.presetGroup.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    // å‘çˆ¶çª—å£å‘é€é¢„è®¾æ—¶é—´æ›´æ–°
                    if (window.parent) {
                        window.parent.postMessage({ 
                            type: 'durationUpdate', 
                            duration: parseInt(input) 
                        }, '*');
                    }
                }
            });
            
            controls.addEventListener('start', () => { controls.autoRotate = false; });
            
            setupEditable(dom.statsTotal, 'è¯·è¾“å…¥æ€»æ•°ï¼š', (val) => {
                stats.total = val; 
                clearForest();
                initRandomEcosystem(val);
                updateStatsDisplay();
            });
            setupEditable(dom.statsToday, 'è¯·è¾“å…¥ä»Šæ—¥æˆå°±æ•°ï¼š', (val) => {
                stats.today = val;
                updateStatsDisplay();
            });

            const presetBtns = dom.presetGroup.querySelectorAll('.preset-btn');
            presetBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const min = parseInt(btn.dataset.time);
                    setDuration(min);
                    // å‘çˆ¶çª—å£å‘é€é¢„è®¾æ—¶é—´æ›´æ–°
                    if (window.parent) {
                        window.parent.postMessage({ 
                            type: 'durationUpdate', 
                            duration: min * 60 
                        }, '*');
                    }
                });
                btn.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    const input = prompt("ä¿®æ”¹é¢„è®¾æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š", btn.dataset.time);
                    if (input && !isNaN(input) && Number(input) > 0) {
                        const newMin = parseInt(input);
                        btn.dataset.time = newMin;
                        btn.innerText = newMin + " min";
                        if(btn.classList.contains('active')) setDuration(newMin);
                        // å‘çˆ¶çª—å£å‘é€é¢„è®¾æ—¶é—´æ›´æ–°
                        if (window.parent) {
                            window.parent.postMessage({ 
                                type: 'durationUpdate', 
                                duration: newMin * 60 
                            }, '*');
                        }
                    }
                });
            });

            window.selectSeed = (type) => {
                currentSeed = type;
                const opts = document.querySelectorAll('.seed-option');
                opts.forEach(el => el.classList.remove('active'));
                const target = document.getElementById('opt-' + type);
                if(target) target.classList.add('active');
                updatePreview(type);
            };

            window.setSound = (type) => {
            currentSound = type;
            const opts = document.querySelectorAll('.audio-item');
            opts.forEach(el => el.classList.remove('selected'));
            Array.from(opts).forEach(el => {
                 if(el.getAttribute('onclick').includes(type)) el.classList.add('selected');
            });
            
            if (type === 'mute' || type === 'none') {
                isMuted = true;
                dom.audioToggle.innerText = 'ğŸ”‡';
                dom.audioPlayer.pause();
            } else {
                isMuted = false;
                dom.audioToggle.innerText = 'ğŸµ';
                playAudio(type);
            }
            
            // å…³é—­éŸ³ä¹èœå•
            isAudioMenuOpen = false;
            const audioMenu = dom.audioToggle.nextElementSibling;
            audioMenu.classList.remove('show');
            
            // å‘çˆ¶çª—å£å‘é€éŸ³æ•ˆçŠ¶æ€æ›´æ–°
            if (window.parent) {
                window.parent.postMessage({ 
                    type: 'soundUpdate', 
                    isMuted, 
                    currentSoundId: type 
                }, '*');
            }
        };
            
            playAudio(currentSound);

            // Exit button click
            // éŸ³ä¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            dom.audioToggle.addEventListener('click', () => {
                isAudioMenuOpen = !isAudioMenuOpen;
                const audioMenu = dom.audioToggle.nextElementSibling;
                if (isAudioMenuOpen) {
                    audioMenu.classList.add('show');
                } else {
                    audioMenu.classList.remove('show');
                }
            });

            dom.exitBtn.addEventListener('click', () => {
                // Send message to parent window to exit immersive mode
                if (window.parent) {
                    window.parent.postMessage('exitImmersive', '*');
                }
            });
            
            // Help button click event
            dom.helpBtn.addEventListener('click', () => {
                // åªæœ‰å½“è®¡æ—¶å™¨æœªè¿è¡Œæ—¶ï¼Œæ‰æ˜¾ç¤ºæŒ‡å—
                if (!isFocusing || isPaused) {
                    dom.guideCard.classList.add('show');
                }
            });
            
            // Guide close button click event
            dom.guideClose.addEventListener('click', () => {
                dom.guideCard.classList.remove('show');
            });
            
            // Click outside the guide card to close it
            dom.guideCard.addEventListener('click', (e) => {
                if (e.target === dom.guideCard) {
                    dom.guideCard.classList.remove('show');
                }
            });

            document.getElementById('loader').style.opacity = 0;
            updateStatsDisplay();
            
            // åˆå§‹åŒ–UIå’Œè¿›åº¦æ¡
            updateTimerUI(secondsLeft);
            setCircleProgress(secondsLeft / currentDuration);
            
            // å¦‚æœåˆå§‹çŠ¶æ€æ˜¯æ¿€æ´»çš„ï¼Œå¼€å§‹è®¡æ—¶ï¼Œå¹¶ä¼ é€’åˆå§‹å‰©ä½™æ—¶é—´
            if (initialIsActive) {
                startFocus(secondsLeft);
            }
        }

        // --- é€»è¾‘å‡½æ•° ---
        
        function setCircleProgress(percent) {
            const offset = FULL_DASH_ARRAY - (percent * FULL_DASH_ARRAY);
            dom.progressCircle.style.strokeDashoffset = offset;
        }

        function setupEditable(element, promptText, callback) {
            element.addEventListener('dblclick', (e) => {
                e.preventDefault(); 
                const numSpan = element.querySelector('.highlight-num');
                const val = numSpan ? numSpan.innerText : element.innerText;
                const input = prompt(promptText, val);
                if(input && !isNaN(input)) {
                    callback(parseInt(input));
                }
            });
        }

        function clearForest() {
            entities.forEach(e => scene.remove(e));
            entities = [];
        }

        function updatePreview(type) {
            if (isFocusing && !isPaused) return; 
            
            if (previewMesh) scene.remove(previewMesh);
            
            if (SPECIES.plants.find(p => p.id === type)) {
                previewMesh = createPlant(type);
            } else {
                previewMesh = createAnimal(type);
            }
            
            previewMesh.position.set(0, 3, 0); 
            previewMesh.scale.set(1.5, 1.5, 1.5);
            previewMesh.userData.isPreview = true;
            scene.add(previewMesh);
        }

        function buildSeedSelector() {
            const container = dom.seedSelector;
            SPECIES.plants.forEach((p, i) => { container.appendChild(createOption(p, i===0)); });
            const animalTitle = document.createElement('div');
            animalTitle.className = 'selector-title';
            animalTitle.style.marginTop = '10px';
            animalTitle.innerText = 'ğŸ¾ åŠ¨ç‰©ç±»';
            container.appendChild(animalTitle);
            SPECIES.animals.forEach(a => { container.appendChild(createOption(a, false)); });
        }

        function createOption(item, isActive) {
            const div = document.createElement('div');
            div.className = 'seed-option ' + (isActive ? 'active' : '');
            div.id = 'opt-' + item.id;
            div.onclick = function() { window.selectSeed(item.id); };
            div.innerHTML = '<span class="seed-icon">' + item.icon + '</span><span class="seed-name">' + item.name + '</span>';
            return div;
        }

        function setDuration(mins) {
            if(isFocusing || isPaused) resetFocus();
            setDurationSeconds(mins * 60);
            const btns = dom.presetGroup.querySelectorAll('.preset-btn');
            btns.forEach(b => b.classList.remove('active'));
            Array.from(btns).forEach(b => {
                if(parseInt(b.dataset.time) === mins) b.classList.add('active');
            });
        }
        
        window.setDuration = setDuration;

        function setDurationSeconds(secs) {
            currentDuration = secs;
            updateTimerUI(secs);
        }

        function playAudio(type) {
            if (type === 'none' || isMuted) return;
            
            // å¦‚æœéŸ³é¢‘æºç›¸åŒä¸”å·²ç»åœ¨æ’­æ”¾ï¼Œåˆ™ä¸é‡æ–°è®¾ç½®ï¼Œä¿æŒè¿ç»­æ€§
            if (dom.audioPlayer.src && dom.audioPlayer.src.includes(SOUNDS[type])) {
                if (dom.audioPlayer.paused) {
                    dom.audioPlayer.play().catch(e => {
                        console.log("Audio waiting for interaction");
                    });
                }
                return;
            }
            
            dom.audioPlayer.src = SOUNDS[type];
            dom.audioPlayer.play().then(() => {
                dom.audioPlayer.volume = 0;
                new TWEEN.Tween(dom.audioPlayer).to({volume: 0.5}, 2000).start();
            }).catch(e => {
                console.log("Audio waiting for interaction");
            });
        }

        function stopAudio() {
            new TWEEN.Tween(dom.audioPlayer).to({volume: 0}, 2000).onComplete(() => {
                dom.audioPlayer.pause();
            }).start();
        }

        // --- ä¸“æ³¨æµç¨‹ ---
        
        function startFocus(initialSecondsLeft = null) {
            isFocusing = true;
            isPaused = false;
            
            // å¦‚æœæä¾›äº†åˆå§‹å‰©ä½™æ—¶é—´ï¼Œåˆ™ä½¿ç”¨å®ƒï¼Œå¦åˆ™ä½¿ç”¨å½“å‰æŒç»­æ—¶é—´
            secondsLeft = initialSecondsLeft !== null ? initialSecondsLeft : currentDuration;
            
            // ç¡®ä¿secondsLeftä¸å¤§äºcurrentDurationï¼Œé˜²æ­¢è¿›åº¦æ¡å¼‚å¸¸
            secondsLeft = Math.min(secondsLeft, currentDuration);

            // UI çŠ¶æ€
            dom.focusRing.classList.add('focusing');
            dom.statusText.innerText = "ä¸“æ³¨ç”Ÿé•¿ä¸­...";
            
            // éšè—é¢æ¿
            dom.seedSelector.classList.add('hidden');
            dom.controlsRow.classList.add('hidden');
            dom.previewLabel.style.opacity = 0;

            // ç§»é™¤é¢„è§ˆ
            if(previewMesh) {
                new TWEEN.Tween(previewMesh.scale).to({x:0, y:0, z:0}, 500).onComplete(() => {
                    scene.remove(previewMesh);
                    previewMesh = null;
                }).start();
            }

            // æ˜¾ç¤ºç•ªèŒ„
            tomatoMesh.visible = true;
            tomatoMesh.scale.set(0,0,0);
            setTimeout(() => {
                new TWEEN.Tween(tomatoMesh.scale).to({x:1, y:1, z:1}, 800).easing(TWEEN.Easing.Back.Out).start();
            }, 500);

            // æ ¹æ®å½“å‰å‰©ä½™æ—¶é—´è®¾ç½®æ­£ç¡®çš„è¿›åº¦æ¡ï¼Œè€Œä¸æ˜¯è®¾ç½®ä¸ºæ»¡å€¼
            const initialPercent = secondsLeft / currentDuration;
            setCircleProgress(Math.min(initialPercent, 1));

            startTimer();
        }

        function startTimer() {
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(!isPaused) {
                    secondsLeft--;
                    updateTimerUI(secondsLeft);
                    
                    // æ›´æ–°è¿›åº¦æ¡: å‰©ä½™ / æ€»
                    const percent = secondsLeft / currentDuration;
                    setCircleProgress(Math.min(percent, 1));
                    
                    // å‘çˆ¶çª—å£å‘é€è®¡æ—¶æ›´æ–°
                    if (window.parent) {
                        window.parent.postMessage({ 
                            type: 'timerUpdate', 
                            timeLeft: secondsLeft, 
                            isActive: isFocusing && !isPaused 
                        }, '*');
                    }

                    if (secondsLeft <= 0) {
                        clearInterval(timerInterval);
                        finishFocus();
                    }
                }
            }, 1000);
        }

        function togglePause() {
            if(!isFocusing) return;
            
            isPaused = !isPaused;
            
            if(isPaused) {
                // æš‚åœ
                dom.statusText.innerText = "å·²æš‚åœ (å•å‡»ç»§ç»­)";
                dom.focusRing.classList.add('paused');
                
                // æµ®ç°é¢æ¿
                dom.seedSelector.classList.remove('hidden');
                dom.controlsRow.classList.remove('hidden');
                
                updatePreview(currentSeed);
                
            } else {
                // ç»§ç»­
                dom.statusText.innerText = "ä¸“æ³¨ç”Ÿé•¿ä¸­...";
                dom.focusRing.classList.remove('paused');
                
                // éšè—é¢æ¿
                dom.seedSelector.classList.add('hidden');
                dom.controlsRow.classList.add('hidden');
                
                if(previewMesh) {
                     new TWEEN.Tween(previewMesh.scale).to({x:0, y:0, z:0}, 300).onComplete(() => {
                        scene.remove(previewMesh);
                        previewMesh = null;
                    }).start();
                }
            }
            
            // å‘çˆ¶çª—å£å‘é€çŠ¶æ€æ›´æ–°
            if (window.parent) {
                window.parent.postMessage({ 
                    type: 'timerUpdate', 
                    timeLeft: secondsLeft, 
                    isActive: isFocusing && !isPaused 
                }, '*');
            }
        }
        
        function resetFocus() {
            isFocusing = false;
            isPaused = false;
            clearInterval(timerInterval);
            
            // æ¢å¤ UI
            dom.focusRing.classList.remove('focusing');
            dom.focusRing.classList.remove('paused');
            dom.statusText.innerText = "ç‚¹å‡»å¼€å§‹";
            setCircleProgress(0); // æ¸…ç©ºè¿›åº¦
            
            dom.seedSelector.classList.remove('hidden');
            dom.controlsRow.classList.remove('hidden');
            dom.previewLabel.style.opacity = 0.6;
            
            tomatoMesh.visible = false;
            updatePreview(currentSeed);
            
            // å‘çˆ¶çª—å£å‘é€çŠ¶æ€æ›´æ–°
            if (window.parent) {
                window.parent.postMessage({ 
                    type: 'timerUpdate', 
                    timeLeft: currentDuration, 
                    isActive: false 
                }, '*');
            }
        }

        function finishFocus() {
            isFocusing = false;
            isPaused = false;
            
            new TWEEN.Tween(tomatoMesh.scale).to({x:0, y:0, z:0}, 300).onComplete(() => {
                tomatoMesh.visible = false;
                spawnEntity(currentSeed, true); 
                setTimeout(() => updatePreview(currentSeed), 1000);
            }).start();

            stats.total++;
            stats.today++;
            updateStatsDisplay();

            // çŠ¶æ€é‡ç½®
            dom.focusRing.classList.remove('focusing');
            setCircleProgress(0);
            updateTimerUI(currentDuration);
            dom.statusText.innerText = "å®Œæˆï¼+1 ç”Ÿå‘½";
            
            dom.seedSelector.classList.remove('hidden');
            dom.controlsRow.classList.remove('hidden');
            dom.previewLabel.style.opacity = 0.6;
            
            // å‘çˆ¶çª—å£å‘é€å®Œæˆé€šçŸ¥
            if (window.parent) {
                window.parent.postMessage({ 
                    type: 'timerUpdate', 
                    timeLeft: currentDuration, 
                    isActive: false, 
                    isComplete: true
                }, '*');
            }
            
            setTimeout(() => {
                dom.statusText.innerText = "ç‚¹å‡»å¼€å§‹";
            }, 2000);
        }

        function spawnEntity(type, isNew = false) {
            let mesh;
            if (SPECIES.plants.find(p => p.id === type)) mesh = createPlant(type);
            else mesh = createAnimal(type);

            const angle = Math.random() * Math.PI * 2;
            const radius = Math.sqrt(Math.random()) * (GROUND_SIZE/2 - 15) + 15;
            mesh.position.set(Math.cos(angle)*radius, 0, Math.sin(angle)*radius);
            mesh.rotation.y = Math.random() * Math.PI * 2;
            
            if (!SPECIES.plants.find(p => p.id === type)) configureAnimal(mesh, type);

            scene.add(mesh);
            entities.push(mesh);

            if (isNew) {
                mesh.scale.set(0,0,0);
                new TWEEN.Tween(mesh.scale).to({x:1, y:1, z:1}, 1000).easing(TWEEN.Easing.Elastic.Out).start();
            }
        }

        // --- Low Poly å»ºæ¨¡ ---
        function createPlant(type) {
            const group = new THREE.Group();
            const trunkMat = new THREE.MeshStandardMaterial({color: 0x5c4033, flatShading:true});
            
            if (type === 'pine') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.4, 1.2, 6), trunkMat);
                trunk.position.y = 0.6; group.add(trunk);
                const leafMat = new THREE.MeshStandardMaterial({color: 0x2d6a4f, flatShading:true});
                for(let i=0; i<3; i++) {
                    const s = 1.3 - i*0.3;
                    const cone = new THREE.Mesh(new THREE.ConeGeometry(s, 1.5, 6), leafMat);
                    cone.position.y = 1.8 + i*0.9;
                    cone.castShadow = true;
                    group.add(cone);
                }
            } else if (type === 'oak' || type === 'cherry') {
                const color = type === 'oak' ? 0x4ade80 : 0xfbcfe8;
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.5, 1.5, 6), trunkMat);
                trunk.position.y = 0.75; group.add(trunk);
                const leafMat = new THREE.MeshStandardMaterial({color: color, flatShading:true});
                const crown = new THREE.Mesh(new THREE.IcosahedronGeometry(1.6, 0), leafMat);
                crown.position.y = 2.2; group.add(crown);
                crown.castShadow = true;
            } else if (type === 'willow') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.4, 2, 6), trunkMat);
                trunk.position.y = 1; group.add(trunk);
                const leafMat = new THREE.MeshStandardMaterial({color: 0x86efac, flatShading:true});
                const top = new THREE.Mesh(new THREE.IcosahedronGeometry(1.2, 0), leafMat);
                top.position.y = 2.2; group.add(top);
                for(let i=0; i<6; i++) {
                    const branch = new THREE.Mesh(new THREE.ConeGeometry(0.2, 1.5, 4), leafMat);
                    branch.position.set(Math.cos(i)*0.8, 1.5, Math.sin(i)*0.8);
                    branch.rotation.x = Math.PI;
                    branch.rotation.z = 0.2;
                    group.add(branch);
                }
            } else if (type === 'bamboo') {
                 const mat = new THREE.MeshStandardMaterial({color: 0x84cc16, flatShading:true});
                 for(let j=0; j<3; j++) {
                     const h = 2 + Math.random();
                     const stalk = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.15, h, 5), mat);
                     stalk.position.set((j-1)*0.4, h/2, (Math.random()-0.5)*0.4);
                     group.add(stalk);
                 }
            } else if (type === 'palm') {
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.25, 3.5, 5), trunkMat);
                trunk.position.y = 1.75; trunk.rotation.z = 0.1; group.add(trunk);
                const leafMat = new THREE.MeshStandardMaterial({color: 0x15803d, flatShading:true, side:THREE.DoubleSide});
                for(let i=0; i<6; i++) {
                    const leaf = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.5, 0.05), leafMat);
                    leaf.position.set(0.2, 3.5, 0);
                    leaf.rotation.z = Math.PI/3; leaf.rotation.y = i * (Math.PI/3); leaf.rotation.x = 0.5; 
                    group.add(leaf);
                }
            } else if (type === 'cactus') {
                const mat = new THREE.MeshStandardMaterial({color: 0x16a34a, flatShading:true});
                const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 2, 6), mat);
                body.position.y = 1; group.add(body);
                const top = new THREE.Mesh(new THREE.IcosahedronGeometry(0.4, 0), mat);
                top.position.y = 2; group.add(top);
                const arm = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 1, 6), mat);
                arm.position.set(0.5, 1.5, 0); arm.rotation.z = -Math.PI/4; group.add(arm);
                body.castShadow = true;
            } else if (type === 'mushroom') {
                const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.4, 1, 6), new THREE.MeshStandardMaterial({color: 0xffedd5, flatShading:true}));
                stem.position.y = 0.5; group.add(stem);
                const cap = new THREE.Mesh(new THREE.ConeGeometry(1.5, 1, 8), new THREE.MeshStandardMaterial({color: 0xff4757, flatShading:true}));
                cap.position.y = 1.0; group.add(cap);
                const spot = new THREE.Mesh(new THREE.IcosahedronGeometry(0.3, 0), new THREE.MeshStandardMaterial({color:0xffffff}));
                spot.position.set(0.5, 1.2, 0.5); group.add(spot);
            } else if (type === 'sunflower') {
                const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 2.5, 5), new THREE.MeshStandardMaterial({color:0x4ade80, flatShading:true}));
                stem.position.y = 1.25; group.add(stem);
                const head = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 0.8, 0.1, 10), new THREE.MeshStandardMaterial({color:0xfacc15, flatShading:true}));
                head.position.set(0, 2.5, 0.2); head.rotation.x = Math.PI/2.5; group.add(head);
                const center = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.3, 0.15, 8), new THREE.MeshStandardMaterial({color: 0x78350f, flatShading:true}));
                center.position.set(0, 2.5, 0.25); center.rotation.x = Math.PI/2.5; group.add(center);
            } else if (type === 'birch') {
                 const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.3, 3, 6), new THREE.MeshStandardMaterial({color: 0xf1f5f9, flatShading:true}));
                 trunk.position.y = 1.5; group.add(trunk);
                 const spot = new THREE.Mesh(new THREE.BoxGeometry(0.21, 0.1, 0.1), new THREE.MeshStandardMaterial({color:0x1e293b}));
                 spot.position.set(0, 1, 0.1); group.add(spot);
                 const crown = new THREE.Mesh(new THREE.IcosahedronGeometry(1.5, 0), new THREE.MeshStandardMaterial({color:0xfcd34d, flatShading:true}));
                 crown.position.y = 3; group.add(crown);
            } else {
                return createPlant('pine');
            }
            return group;
        }

        function createAnimal(type) {
            const group = new THREE.Group();
            const mat = (col) => new THREE.MeshStandardMaterial({color:col, flatShading:true});
            const geo = (w, h, d) => new THREE.BoxGeometry(w,h,d);

            if (type === 'fox') {
                const body = new THREE.Mesh(geo(0.5, 0.4, 0.8), mat(0xf97316)); body.position.y = 0.4; group.add(body);
                const head = new THREE.Mesh(new THREE.ConeGeometry(0.35, 0.6, 4), mat(0xf97316)); 
                head.position.set(0, 0.8, 0.5); head.rotation.x = -Math.PI/2; head.rotation.y = Math.PI/4; group.add(head);
                const tail = new THREE.Mesh(geo(0.3, 0.3, 0.7), mat(0xf97316)); tail.position.set(0, 0.6, -0.7); tail.rotation.x = 0.5; group.add(tail);
            } else if (type === 'rabbit') {
                const body = new THREE.Mesh(new THREE.IcosahedronGeometry(0.4, 0), mat(0xffffff)); body.position.y = 0.4; group.add(body);
                const head = new THREE.Mesh(new THREE.IcosahedronGeometry(0.25, 0), mat(0xffffff)); head.position.set(0, 0.7, 0.3); group.add(head);
                const ears = new THREE.Mesh(geo(0.1, 0.4, 0.1), mat(0xffffff)); ears.position.set(0, 1.0, 0.3); group.add(ears);
                const ears2 = new THREE.Mesh(geo(0.1, 0.4, 0.1), mat(0xffffff)); ears2.position.set(-0.1, 1.0, 0.3); group.add(ears2);
            } else if (type === 'pig') {
                const body = new THREE.Mesh(geo(0.6, 0.5, 0.8), mat(0xfbcfe8)); body.position.y = 0.4; group.add(body);
                const head = new THREE.Mesh(geo(0.4, 0.4, 0.4), mat(0xfbcfe8)); head.position.set(0, 0.5, 0.5); group.add(head);
                const nose = new THREE.Mesh(geo(0.2, 0.15, 0.1), mat(0xf9a8d4)); nose.position.set(0, 0.5, 0.75); nose.rotation.x = Math.PI/2; group.add(nose);
            } else if (type === 'panda') {
                const body = new THREE.Mesh(geo(0.7, 0.6, 1.0), mat(0xffffff)); body.position.y = 0.5; group.add(body);
                const head = new THREE.Mesh(geo(0.5, 0.4, 0.4), mat(0xffffff)); head.position.set(0, 0.8, 0.4); group.add(head);
                const leg = new THREE.Mesh(geo(0.2,0.3,0.2), mat(0x1f2937)); leg.position.set(0.3,0.2,0.3); group.add(leg);
                const leg2 = leg.clone(); leg2.position.set(-0.3,0.2,0.3); group.add(leg2);
                const ear = new THREE.Mesh(geo(0.15,0.15,0.1), mat(0x1f2937)); ear.position.set(0.2,1.0,0.4); group.add(ear);
                const ear2 = ear.clone(); ear2.position.set(-0.2,1.0,0.4); group.add(ear2);
            } else if (type === 'penguin') {
                 const body = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.35, 0.9, 7), mat(0x1f2937)); body.position.y = 0.45; group.add(body);
                 const belly = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.3, 0.8, 6), mat(0xffffff)); belly.position.set(0,0.45,0.1); group.add(belly);
                 const beak = new THREE.Mesh(new THREE.ConeGeometry(0.1, 0.2, 4), mat(0xfacc15)); beak.position.set(0, 0.85, 0.25); beak.rotation.x = Math.PI/2; group.add(beak);
            } else if (type === 'frog') {
                 const body = new THREE.Mesh(new THREE.IcosahedronGeometry(0.3, 0), mat(0x4ade80)); body.position.y = 0.3; group.add(body);
                 const eye = new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1), mat(0x1f2937)); eye.position.set(0.15,0.5,0.15); group.add(eye);
                 const eye2 = eye.clone(); eye2.position.set(-0.15,0.5,0.15); group.add(eye2);
            } else if (type === 'bee') {
                 const body = new THREE.Mesh(new THREE.IcosahedronGeometry(0.25, 0), mat(0xfacc15)); body.position.y = 0.5; group.add(body);
                 const stripe = new THREE.Mesh(new THREE.TorusGeometry(0.26, 0.05, 4, 6), mat(0x000000)); stripe.position.y = 0.5; stripe.rotation.x=Math.PI/2; group.add(stripe);
                 const wing = new THREE.Mesh(new THREE.PlaneGeometry(0.4, 0.2), new THREE.MeshBasicMaterial({color:0xffffff, opacity:0.6, transparent:true, side:THREE.DoubleSide}));
                 wing.position.set(0, 0.7, 0); wing.rotation.x=Math.PI/2; group.add(wing);
            } else if (type === 'sheep') {
                 const body = new THREE.Mesh(new THREE.IcosahedronGeometry(0.5, 0), mat(0xffffff)); body.position.y = 0.5; group.add(body);
                 const head = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.35), mat(0x1f2937)); head.position.set(0, 0.6, 0.4); group.add(head);
            } else if (type === 'bear') {
                 const body = new THREE.Mesh(geo(0.7, 0.6, 1.0), mat(0x78350f)); body.position.y = 0.5; group.add(body);
                 const head = new THREE.Mesh(geo(0.5, 0.4, 0.4), mat(0x78350f)); head.position.set(0, 0.7, 0.5); group.add(head);
                 const snout = new THREE.Mesh(geo(0.2, 0.15, 0.15), mat(0x000000)); snout.position.set(0, 0.7, 0.75); group.add(snout);
            } else {
                 const body = new THREE.Mesh(new THREE.IcosahedronGeometry(0.3, 0), mat(0xfacc15)); body.position.y = 0.3; group.add(body);
                 const beak = new THREE.Mesh(new THREE.ConeGeometry(0.05,0.1,4), mat(0xf97316)); beak.position.set(0,0.4,0.25); beak.rotation.x=Math.PI/2; group.add(beak);
            }
            return group;
        }

        function configureAnimal(mesh, type) {
            const data = {
                isAnimal: true,
                type: type,
                speed: 0.02 + Math.random()*0.02,
                direction: new THREE.Vector3(Math.random()-0.5, 0, Math.random()-0.5).normalize(),
                timeOffset: Math.random() * 100
            };
            if (type === 'rabbit' || type === 'frog') {
                data.moveType = 'hop';
                data.hopHeight = type === 'frog' ? 1.5 : 1.2;
                data.hopFreq = 4;
            } else if (type === 'bee') {
                data.moveType = 'fly';
                data.flyHeight = 2.0;
                data.speed = 0.05;
            } else {
                data.moveType = 'walk';
                data.wobbleFreq = 8;
                data.wobbleAmp = 0.15;
            }
            mesh.userData = data;
        }

        function createGround() {
            const geo = new THREE.CylinderGeometry(GROUND_SIZE/2, GROUND_SIZE/2, 4, 64);
            const mat = new THREE.MeshStandardMaterial({color: 0xe0e5ec, flatShading:false}); 
            ground = new THREE.Mesh(geo, mat);
            ground.position.y = -2;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        function createTomato() {
            const group = new THREE.Group();
            group.visible = false;
            
            // ç•ªèŒ„ä¸»ä½“
            const body = new THREE.Mesh(new THREE.IcosahedronGeometry(1.5, 2), new THREE.MeshStandardMaterial({color: 0xf43f5e, flatShading:false}));
            body.castShadow = true;
            group.add(body);
            
            // ç•ªèŒ„è’‚
            const stem = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 0.5, 6), new THREE.MeshStandardMaterial({color: 0x16a34a}));
            stem.position.y = 1.5;
            group.add(stem);
            
            const leaf = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.05), new THREE.MeshStandardMaterial({color: 0x16a34a}));
            leaf.position.set(0.2, 1.7, 0);
            leaf.rotation.z = 0.5;
            group.add(leaf);
            
            const leaf2 = leaf.clone();
            leaf2.position.set(-0.2, 1.7, 0);
            leaf2.rotation.z = -0.5;
            group.add(leaf2);
            
            tomatoMesh = group;
            scene.add(tomatoMesh);
        }

        function initRandomEcosystem(count) {
            const allSpecies = [...SPECIES.plants, ...SPECIES.animals];
            for(let i=0; i<count; i++) {
                const randomType = allSpecies[Math.floor(Math.random() * allSpecies.length)].id;
                spawnEntity(randomType);
            }
        }

        function updateStatsDisplay() {
            dom.total.innerText = stats.total;
            dom.today.innerText = stats.today;
        }

        function updateTimerUI(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            dom.timer.innerText = mins.toString().padStart(2, '0') + ':' + secs.toString().padStart(2, '0');
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            TWEEN.update();
            
            // Animate animals
            entities.forEach(entity => {
                if (entity.userData.isAnimal) {
                    const data = entity.userData;
                    const time = performance.now() * 0.001 + data.timeOffset;
                    
                    if (data.moveType === 'walk') {
                        // Simple walk animation
                        entity.position.x += Math.cos(time * data.speed * 5) * 0.02;
                        entity.position.z += Math.sin(time * data.speed * 5) * 0.02;
                        entity.rotation.y = Math.atan2(
                            data.direction.x,
                            data.direction.z
                        );
                        
                        // Wobble effect
                        entity.position.y = Math.sin(time * data.wobbleFreq) * data.wobbleAmp + 0.2;
                    } else if (data.moveType === 'hop') {
                        // Hop animation
                        const hopHeight = Math.sin(time * data.hopFreq) * data.hopHeight;
                        entity.position.y = hopHeight;
                        
                        // Forward movement
                        entity.position.x += data.direction.x * data.speed;
                        entity.position.z += data.direction.z * data.speed;
                    } else if (data.moveType === 'fly') {
                        // Fly animation - 3D movement
                        entity.position.x += Math.cos(time * data.speed * 2) * 0.05;
                        entity.position.y = Math.sin(time * data.speed * 3) * data.flyHeight + data.flyHeight;
                        entity.position.z += Math.sin(time * data.speed * 2) * 0.05;
                    }
                    
                    // Keep within bounds
                    const dist = Math.sqrt(entity.position.x ** 2 + entity.position.z ** 2);
                    if (dist > GROUND_SIZE / 2 - 10) {
                        data.direction = new THREE.Vector3(
                            -entity.position.x / dist,
                            0,
                            -entity.position.z / dist
                        ).normalize();
                    }
                }
            });
            
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>