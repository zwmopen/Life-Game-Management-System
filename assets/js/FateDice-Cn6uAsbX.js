import{j as e}from"./index-DMztQwJg.js";import{r as t}from"./recharts-Du2nWM4a.js";import{j as n,c as o,d as a,r as s,e as l,W as r,f as i,s as c,A as d,D as u,o as h,t as m,u as x,h as p,v as f}from"./three-BIQ0MFnl.js";const v=t.memo(({theme:v,diceState:b,onSpinDice:w,onUpdateDiceState:M,onAddFloatingReward:g})=>{const y=t.useRef(null),F=t.useRef(null),[k,D]=t.useState(!1);t.useState(null);const N=t.useRef(null),[A,C]=t.useState((null==b?void 0:b.todayCount)||0),[$,j]=t.useState((null==b?void 0:b.config.dailyLimit)||10),[z,R]=t.useState(!1),[S,q]=t.useState(!1),I=$-A,T=t.useRef(null),E=t.useRef(null),B=t.useRef(null),K=t.useRef(null),O=v.includes("dark"),P=v.startsWith("neomorphic"),U="neomorphic-dark"===v,W=P?U?"#1e1e2e":"#e0e5ec":O?"#1e1e2e":"#e0e5ec",Y=P?U?"#d8d8d8":"#4d5b6d":O?"#d8d8d8":"#4d5b6d",G=U?"#1a1a2e":"#ffffff",H=U?"#0f0f1e":"#a3b1c6",J=e=>{const t=new x(3.5,3.5,3.5,10,.3),o=(e=>{const t=512,n=[];return[2,5,3,4,1,6].forEach(o=>{const a=document.createElement("canvas");a.width=t,a.height=t;const s=a.getContext("2d");if(s){s.fillStyle="#ffffff",s.fillRect(0,0,t,t);const e=s.createRadialGradient(256,256,0,256,256,t);e.addColorStop(0,"rgba(255, 255, 255, 1)"),e.addColorStop(1,"rgba(240, 245, 250, 1)"),s.fillStyle=e,s.fillRect(0,0,t,t),((e,t,n)=>{const o=n/10,a=n/2,s=n/3.6,l=(t,n,a)=>{e.beginPath(),e.arc(t,n,o,0,2*Math.PI),e.fillStyle=a,e.fill(),e.shadowBlur=8,e.shadowOffsetX=3,e.shadowOffsetY=3,e.shadowColor="rgba(163,177,198, 0.8)",e.stroke(),e.shadowColor="transparent",e.beginPath(),e.arc(t,n,o,0,2*Math.PI),e.strokeStyle="rgba(255,255,255, 0.9)",e.lineWidth=3,e.stroke()},r=1===t?"#ef4444":"#1e293b";if(1===t)return e.beginPath(),e.arc(a,a,1.6*o,0,2*Math.PI),e.fillStyle=r,e.fill(),e.strokeStyle="rgba(0,0,0,0.05)",e.lineWidth=2,void e.stroke();t>1&&(l(a-s,a-s,r),l(a+s,a+s,r)),t>3&&(l(a+s,a-s,r),l(a-s,a+s,r)),6===t&&(l(a-s,a,r),l(a+s,a,r)),t%2==1&&l(a,a,r)})(s,o,t)}const l=new f(a);l.anisotropy=e.capabilities.getMaxAnisotropy(),n.push(l)}),n})(e),a=o.map(e=>new p({map:e,color:16777215,roughness:.15,metalness:.05,envMapIntensity:1})),s=new n(t,a);return s.castShadow=!0,s.receiveShadow=!0,s.rotation.x=Math.random()*Math.PI,s.rotation.y=Math.random()*Math.PI,s},L=t.useRef(0),Q=()=>{if(L.current=requestAnimationFrame(Q),B.current&&T.current&&E.current&&K.current){if(!k){const e=.001*Date.now();K.current.position.y=.12*Math.sin(e),K.current.rotation.x+=.001,K.current.rotation.y+=.002}B.current.domElement.style.pointerEvents=k?"none":"auto",B.current.render(T.current,E.current)}},V=()=>{if(!N.current)return;const e=N.current,t=e.currentTime;for(let n=0;n<8;n++){const o=600+400*Math.random(),a=.05+.05*Math.random(),s=e.createOscillator(),l=e.createGain();s.connect(l),l.connect(e.destination),s.type="square",l.gain.setValueAtTime(.5,t+.1*n),l.gain.exponentialRampToValueAtTime(.01,t+.1*n+a),s.frequency.setValueAtTime(o,t+.1*n),s.frequency.exponentialRampToValueAtTime(.5*o,t+.1*n+a),s.start(t+.1*n),s.stop(t+.1*n+a)}};t.useRef(null);const X=()=>{if(!E.current||!B.current||!F.current)return;const e=F.current.clientWidth,t=F.current.clientHeight;B.current.domElement.width===e&&B.current.domElement.height===t||(E.current.aspect=e/t,E.current.updateProjectionMatrix(),B.current.setSize(e,t),B.current.setPixelRatio(window.devicePixelRatio))};return t.useEffect(()=>{const e=e=>{if(k)return e.preventDefault(),e.stopPropagation(),!1},t=y.current;t&&(t.addEventListener("wheel",e,{passive:!1}),t.addEventListener("touchmove",e,{passive:!1}),t.addEventListener("keydown",e,{passive:!1}));const n=e=>{if(k)return e.preventDefault(),e.stopPropagation(),!1};return k&&t&&(document.body.addEventListener("wheel",n,{passive:!1}),document.body.addEventListener("touchmove",n,{passive:!1})),()=>{t&&(t.removeEventListener("wheel",e),t.removeEventListener("touchmove",e),t.removeEventListener("keydown",e)),document.body.removeEventListener("wheel",n),document.body.removeEventListener("touchmove",n)}},[]),t.useEffect(()=>{const e=e=>{if(k)return e.preventDefault(),!1};return k&&(document.body.addEventListener("wheel",e,{passive:!1}),document.body.addEventListener("touchmove",e,{passive:!1})),()=>{document.body.removeEventListener("wheel",e),document.body.removeEventListener("touchmove",e)}},[k]),t.useEffect(()=>{(()=>{if(!F.current)return void console.error("Canvas container not found");const e=F.current.clientWidth,t=F.current.clientHeight,x=new o;x.background=new a(W),x.fog=new s(W,8,25),T.current=x;const p=new l(45,e/t,.1,100);p.position.set(0,0,10),E.current=p;const f=new r({antialias:!0});f.setSize(e,t),f.setPixelRatio(window.devicePixelRatio),f.shadowMap.enabled=!0,f.shadowMap.type=i,f.toneMapping=c,f.toneMappingExposure=1.1,F.current.innerHTML="",F.current.appendChild(f.domElement),B.current=f;const v=new d(16777215,.5);x.add(v);const b=new u(16777215,1.5);b.position.set(-5,10,5),b.castShadow=!0,b.shadow.mapSize.width=1024,b.shadow.mapSize.height=1024,b.shadow.radius=2,b.shadow.bias=-1e-4,x.add(b);const w=new u(16777215,.8);w.position.set(5,5,5),x.add(w);const M=new h(100,100),g=new m({opacity:.1,color:5069677}),y=new n(M,g);y.rotation.x=-Math.PI/3,y.position.y=-10,y.receiveShadow=!0,x.add(y);const k=J(f);x.add(k),K.current=k,f.render(x,p),Q()})(),window.addEventListener("resize",X);let e=null;F.current&&(e=new ResizeObserver(()=>{setTimeout(X,0)}),e.observe(F.current)),setTimeout(()=>{X()},100);const t=setInterval(()=>{k&&(console.warn("FateDice: Animation timeout detected, resetting isRolling state"),D(!1))},5e3);return()=>{clearInterval(t),window.removeEventListener("resize",X),e&&(e.disconnect(),e=null),L.current&&cancelAnimationFrame(L.current),B.current&&(B.current.dispose(),B.current=null),T.current&&(T.current.traverse(e=>{if(e instanceof n&&(e.geometry&&e.geometry.dispose(),e.material))if(Array.isArray(e.material))e.material.forEach(e=>{e.map&&e.map.dispose(),e.lightMap&&e.lightMap.dispose(),e.bumpMap&&e.bumpMap.dispose(),e.normalMap&&e.normalMap.dispose(),e.specularMap&&e.specularMap.dispose(),e.alphaMap&&e.alphaMap.dispose(),e.aoMap&&e.aoMap.dispose(),e.displacementMap&&e.displacementMap.dispose(),e.emissiveMap&&e.emissiveMap.dispose(),e.environmentMap&&e.environmentMap.dispose(),e.dispose()});else{const t=e.material;t.map&&t.map.dispose(),t.lightMap&&t.lightMap.dispose(),t.bumpMap&&t.bumpMap.dispose(),t.normalMap&&t.normalMap.dispose(),t.specularMap&&t.specularMap.dispose(),t.alphaMap&&t.alphaMap.dispose(),t.aoMap&&t.aoMap.dispose(),t.displacementMap&&t.displacementMap.dispose(),t.emissiveMap&&t.emissiveMap.dispose(),t.environmentMap&&t.environmentMap.dispose(),t.dispose()}}),T.current=null),E.current&&(E.current=null),K.current&&(K.current=null),N.current&&("closed"!==N.current.state&&N.current.close(),N.current=null)}},[v,W,H,G,Y]),t.useEffect(()=>{void 0!==(null==b?void 0:b.todayCount)&&C(b.todayCount),void 0!==(null==b?void 0:b.config.dailyLimit)&&j(b.config.dailyLimit)},[null==b?void 0:b.todayCount,null==b?void 0:b.config.dailyLimit]),e.jsxs("div",{ref:y,className:"w-full mx-auto rounded-xl p-1 xs:p-2 sm:p-3 md:p-4 transition-all duration-300 max-w-none",style:{backgroundColor:W,boxShadow:`9px 9px 16px ${H}, -9px -9px 16px ${G}`,transform:"translateY(0)",transition:"all 0.3s ease"},children:[e.jsx("div",{ref:F,className:"w-full h-[120px] xs:h-[150px] sm:h-[200px] md:h-[250px] lg:h-[300px] mb-4 rounded-xl overflow-hidden relative",style:{backgroundColor:W}}),e.jsx("div",{className:"mb-4 text-center px-2",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-center gap-1 xs:gap-2 text-xs sm:text-sm md:text-base",children:[e.jsx("div",{className:"font-medium truncate max-w-[100px]",style:{color:Y},children:"今日剩余次数"}),z?e.jsx("input",{type:"number",min:"0",max:$,value:I,onChange:e=>{const t=Math.max(0,parseInt(e.target.value)||0);C($-t)},className:`text-base font-bold ${O?"text-blue-400":"text-blue-600"} bg-transparent border-b border-blue-400 focus:outline-none w-12 text-center`,style:{color:O?"#3b82f6":"#2563eb"},autoFocus:!0,onBlur:()=>{R(!1),M&&M({todayCount:A})},onKeyPress:e=>{"Enter"===e.key&&(R(!1),M&&M({todayCount:A}))}}):e.jsx("div",{className:"text-base font-bold cursor-pointer "+(O?"text-blue-400":"text-blue-600"),onDoubleClick:()=>R(!0),children:I}),e.jsx("div",{className:"text-base font-bold",style:{color:Y},children:"/"}),e.jsx("div",{className:"text-base font-bold cursor-pointer",style:{color:Y},onDoubleClick:()=>q(!0),children:$})]})}),e.jsx("div",{className:"text-center px-1 xs:px-2",children:e.jsx("button",{onClick:k||(null==b?void 0:b.isSpinning)||I<=0?void 0:()=>{if(k||!K.current||!w||(null==b?void 0:b.isSpinning)||I<=0)return;try{const e=new Audio("/audio/sfx/投骰子音效.mp3");e.volume=.7,e.play().catch(e=>{console.warn("FateDice: Audio playback failed, falling back to generated sound:",e),V()})}catch(m){console.warn("FateDice: Failed to create audio element, using generated sound:",m),V()}D(!0),setTimeout(()=>{k&&(console.warn("FateDice: Roll animation timed out, resetting isRolling state"),D(!1))},3e3);const e=Math.floor(6*Math.random())+1,t={1:{x:0,y:0},6:{x:Math.PI,y:0},2:{x:0,y:-Math.PI/2},5:{x:0,y:Math.PI/2},3:{x:-Math.PI/2,y:0},4:{x:Math.PI/2,y:0}}[e],n=(Math.floor(3*Math.random())+4)*(2*Math.PI),o=(Math.floor(3*Math.random())+4)*(2*Math.PI),a=K.current.rotation.x,s=K.current.rotation.y,l={x:a+n+(t.x-a%(2*Math.PI)),y:s+o+(t.y-s%(2*Math.PI))};let r=t.x-a%(2*Math.PI);r<0&&(r+=2*Math.PI),l.x=a+r+n;let i=t.y-s%(2*Math.PI);i<0&&(i+=2*Math.PI),l.y=s+i+o;const c=performance.now(),d=a,u=s,h=e=>{const t=e-c,n=Math.min(t/2500,1),o=1-Math.pow(1-n,4);if(K.current&&(K.current.rotation.x=d+(l.x-d)*o,K.current.rotation.y=u+(l.y-u)*o,K.current.position.y=n<1?Math.sin(n*Math.PI*5)*(1-n)*1.8:0),n<1)requestAnimationFrame(h);else{C(e=>Math.min(e+1,$));const e=w();!e.success&&e.message&&g&&g(e.message,"text-red-500"),D(!1),setTimeout(()=>{B.current&&B.current.domElement&&(B.current.domElement.style.pointerEvents="auto")},100)}};requestAnimationFrame(h)},disabled:k||(null==b?void 0:b.isSpinning)||I<=0,className:`w-full py-1.5 xs:py-2 px-3 xs:px-4 text-sm xs:text-base sm:text-lg font-bold rounded-md transition-all duration-300 ${P?U?"bg-[#1e1e2e] text-blue-400 hover:text-blue-300":"bg-[#e0e5ec] text-blue-600 hover:text-blue-700":O?"bg-zinc-800 hover:bg-zinc-700 text-white":"bg-slate-100 hover:bg-slate-200 text-slate-800"} ${P?`shadow-${U?"inner":"md"} hover:shadow-lg active:shadow-inner`:"shadow-sm"} ${k||(null==b?void 0:b.isSpinning)||I<=0?"opacity-60 cursor-not-allowed":""}`,style:{boxShadow:P?`9px 9px 16px ${H}, -9px -9px 16px ${G}`:"",pointerEvents:k||(null==b?void 0:b.isSpinning)||I<=0?"none":"auto"},children:k||(null==b?void 0:b.isSpinning)?"投掷中...":"开始投掷"})})]})});v.displayName="FateDice";export{v as F};//# sourceMappingURL=FateDice-Cn6uAsbX.js.map
